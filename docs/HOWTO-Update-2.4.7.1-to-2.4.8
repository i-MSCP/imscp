HOWTO Update ISPCP 2.4.7.1 to ISPCP 2.4.8 Ï‰ (English)


-------------------
General Information
-------------------

1) Change to your <ISPCP-SOURCE-DIR>. (This is only a variable for your temporary install direction.)

2) Download the newest ISPCP release :

# wget http://isp-control.net/ispcp/ispcp-2.4.8.tar.bz2

3) Turn off the ISPCP Daemon:

# /etc/init.d/ispcp_daemon stop

4) Make a backup of the current ISPCP files of your system:

# mv /var/www/ispcp/gui /var/www/ispcp/gui_bcp_yyyymmdd
# mv /var/www/ispcp/engine /var/www/ispcp/engine_bcp_yyyymmdd

5) Unpack the downloaded archive:

#tar -xjf ispcp-2.4.8.tar.bz2


-------------------
System Update
-------------------

Install php4-cgi php5-cgi php4-mysql php5-mysql

# apt-get install php4-cgi php5-cgi php4-mysql php5-mysql

-------------------
ispcp.conf Update
-------------------


1) Change these following lines:

BuildDate = XX.XX.2006

Version = 2.4.8

ISPCP_LICENSE = ISPCP<sup>&reg;</sup> Pro v2.4.8<br>build: 2006-XX-XX<br>Rhea

2) Some language database tables will be changed with the next steps so an update here is needed if you

if your USER_INITIAL_LANG looks like:
	USER_INITIAL_LANG = lang_Deutsch
you must turn it to :
	USER_INITIAL_LANG = lang_German

if your USER_INITIAL_LANG looks like:
	USER_INITIAL_LANG = lang_Portugues_Brasil
you must turn it to :
	USER_INITIAL_LANG = lang_PortuguesBrazil


-------------------
Postfix main.cf update
-------------------

1) Edit /etc/postfix/main.cf

and search for the line: "local_recipient_maps = unix:passwd.byname $alias_database"
and insert directly under this line:

#
# ISPCP Autoresponder paramters;
#

ispcp-arpl_destination_recipient_limit = 1

-------------------
Postfix master.cf update
-------------------

If you want/need it you can take a look at the preconfiguration for amavis in the
master.cf in <ISPCP-SOURCE-DIR>/configs/postfix/master.cf You'll find the entrys at the end of the file

-------------------
proftpd.conf update
-------------------

1) Open /etc/proftpd.conf

2) Copy the Value of "ServerName"

For Proftpd < 1.3:
3) Move <ISPCP-SOURCE-DIR>/configs/proftpd/proftpd.conf to /etc/

# mv <ISPCP-SOURCE-DIR>/configs/proftpd/proftpd.conf /etc/

For Proftpd >= 1.3:

3) Move <ISPCP-SOURCE-DIR>/configs/proftpd/proftpd.conf to /etc/proftpd/

# mkdir /etc/proftpd/
# mv <ISPCP-SOURCE-DIR>/configs/proftpd/proftpd.conf /etc/proftpd/

3a) Uncomment the lines 9 and 97

4) Replace the Value of "ServerName" in /etc/proftpd.conf with the old one.


-------------------
Engine Update
-------------------

1) Copy the new engine files

# cp -a <ISPCP-SOURCE-DIR>/engine/ /var/www/ispcp/

2) Copy your crypt key from the old /engine_bcp_yyyymmdd/ispcp-db-keys.pl to /engine/ispcp-db-keys.pl

# cp /var/www/ispcp/engine_bcp_yyyymmdd/ispcp-db-keys.pl /var/www/ispcp/engine/ispcp-db-keys.pl

3) Copy your crypt key from the old /engine_bcp_yyyymmdd/ispcp-db-keys.pl to /engine/messager/ispcp-db-keys.pl

# cp /var/www/ispcp/engine_bcp_yyyymmdd/ispcp-db-keys.pl /var/www/ispcp/engine/messager/ispcp-db-keys.pl

4) Copy phptemp cleanup cron script:

# cp <ISPCP-SOURCE-DIR>/configs/cron.d/ispcp.phptemp /etc/cron.d/



The new autoresponder logs to his own directory (needs extra permissions)

	mkdir -p /var/log/ispcp/ispcp-arpl-msgr
	chown vmail:mail /var/log/ispcp/ispcp-arpl-msgr

Extra notes for chown command:
vmail is value of MTA_MAILBOX_UID_NAME from ispcp.conf
mail is value of MTA_MAILBOX_GID_NAME from ispcp.conf


Backup Engine Update
-------------------

1) Delete old no longer needed backup manager if it exists

# rm /var/www/ispcp/engine/tools/ispcp-backup-all

2) Check and maybe change the crontab line for the backup

# crontab -e

if line looks like:

/var/www/ispcp/engine/tools/ispcp-backup-all yes &>/var/log/ispcp/ispcp-backup-all-mngr.log

change it to:

/var/www/ispcp/engine/backup/ispcp-backup-all yes &>/var/log/ispcp/ispcp-backup-all-mngr.log


Engine Templates Update
-------------------

1) Update templates:

# cp <ISPCP-SOURCE-DIR>/configs/apache/parts/* /etc/ispcp/apache/parts/
# cp <ISPCP-SOURCE-DIR>/configs/bind/parts/* /etc/ispcp/bind/parts/

If you changed any templates, they're updated in this release and need to be updated with your own changes.

If you installed global applications like horde or others and defined entrys like:

Alias /horde /var/www/horde
Alias /webmail /var/www/horde
<Directory /var/www/horde>
    AllowOverride none
    Options MultiViews IncludesNoExec FollowSymLinks
    php_admin_value open_basedir "/var/www/horde/:/usr/share/php/:/tmp/:/var/tmp/"
</Directory>

	then you need to add a global session.save_path and upload_tmp_dir to these entrys, like that:

Alias /horde /var/www/horde
Alias /webmail /var/www/horde
<Directory /var/www/horde>
    AllowOverride none
    Options MultiViews IncludesNoExec FollowSymLinks
    php_admin_value open_basedir "/var/www/horde/:/usr/share/php/:/tmp/:/var/tmp/"
    php_admin_value session.save_path "/tmp/"
    php_admin_value upload_tmp_dir "/tmp/"
</Directory>



Finish Engine Updates
-------------------

1) Set correct engine permissions:

# /var/www/ispcp/engine/setup/set-engine-permissions.sh


-------------------
GUI Update
-------------------

1) Copy the new GUI files

# cp -a <ISPCP-SOURCE-DIR>/gui/ /var/www/ispcp/

2) Copy your crypt key from the old /gui_bcp_yyyymmdd/include/ispcp-db-keys.php to /gui/include/ispcp-db-keys.php

# cp /var/www/ispcp/gui_bcp_yyyymmdd/include/ispcp-db-keys.php /var/www/ispcp/gui/include/ispcp-db-keys.php

3) If you want to see date and time in your default language on the ispcp login page you need to configure system locales
   on debian run: dpkg-reconfigure locales (or if not installed: apt-get install locales) then select the locales you want to use.
   After generating the locales (takes some time) restart your Apache webserver (/etc/init.d/apache2 restart).

4) Set correct gui permissions:

# /var/www/ispcp/engine/setup/set-gui-permissions.sh

5) Copy new and secured errorpages:

# /var/www/ispcp/engine/setup/copy-errordocs.sh

-------------------
Database Update
-------------------

1) Database structure must be updated:
   (instead of copying these lines into an SQL shell, you can use the supplied SQL-Update-2.4.7.1-to-2.4.8.sql update file)

ALTER TABLE `ispcp`.`login` ADD `ipaddr` varchar(15) NULL AFTER `session_id`;
ALTER TABLE `ispcp`.`login` ADD `user_name` varchar(255) NULL AFTER `ipaddr`;
ALTER TABLE `ispcp`.`login` ADD `login_count` tinyint(1) NULL AFTER `lastaccess`;

CREATE TABLE `ispcp`.`config` (`name` varchar(255) NOT NULL default '',`value` varchar(255) NOT NULL default '',PRIMARY KEY  (`name`));
INSERT INTO `config` (`name`,`value`) VALUES ('PORT_FTP','21;tcp;FTP;1;0'),('PORT_SSH','22;tcp;SSH;1;0'),('PORT_TELNET','23;tcp;TELNET;1;0'),('PORT_SMTP','25;tcp;SMPT;1;0'),('PORT_DNS','53;tcp;DNS;1;0'),('PORT_HTTP','80;tcp;HTTP;1;0'),('PORT_HTTPS','443;tcp;HTTPS;1;0'),('PORT_POP3','110;tcp;POP3;1;0'),('PORT_POP3-SSL','995;tcp;POP3-SSL;1;0'),('PORT_IMAP','143;tcp;IMAP;1;0'),('PORT_IMAP-SSL','993;tcp;IMAP-SSL;1;0');

ALTER TABLE `ispcp`.`admin` ADD `uniqkey_time` TIMESTAMP NULL AFTER `uniqkey`;
ALTER TABLE `ispcp`.`admin` ADD UNIQUE ( `admin_name` );
ALTER TABLE `ispcp`.`domain` ADD INDEX i_domain_domain_admin_id ( `domain_admin_id` );
ALTER TABLE `ispcp`.`domain` ADD UNIQUE ( `domain_name` );
ALTER TABLE `ispcp`.`domain_traffic` ADD INDEX i_domain_traffic_domain_id ( `domain_id` );

ALTER TABLE `ispcp`.`htaccess_users` ADD `status` varchar(255) default NULL;
ALTER TABLE `ispcp`.`htaccess_groups` ADD `status` varchar(255) default NULL;
ALTER TABLE `ispcp`.`htaccess` CHANGE `status` `status` VARCHAR( 255 ) default NULL;

2) Updated languages completely by importing the languages.sql For example with phpmyadmin or over commandline.
All languages are changed. Please use languages.sql because it's the only way to update lang_english which is
not update-able by language file. languages.sql is located in:

configs/database/languages.sql

2.1) Drop the not working language tables, the new one will be imported with the next step.

DROP TABLE IF EXISTS `ispcp`.`lang_Deutsch`;
DROP TABLE IF EXISTS `ispcp`.`lang_Portugues_Brasil`;

2.2) Update the user properties

UPDATE `ispcp`.`user_gui_props` SET `lang` = 'lang_German' WHERE `lang` = 'lang_Deutsch';
UPDATE `ispcp`.`user_gui_props` SET `lang` = 'lang_PortuguesBrazil' WHERE `lang` = 'lang_Portugues_Brasil';

2.3) The update of the user-porp. recommand a session clean up

DELETE FROM `ispcp`.`login`;

3) Change status for rebuild apache conf for all domains:

UPDATE `ispcp`.`subdomain` SET `subdomain_status` = 'change' WHERE `subdomain_status` = 'ok';
UPDATE `ispcp`.`domain` SET `domain_status` = 'change' WHERE `domain_status` = 'ok';
UPDATE `ispcp`.`domain_aliasses` SET `alias_status` = 'change' WHERE `alias_status` = 'ok';


-------------------
Daemon & init.d Update
-------------------

1) Make the new daemon:

# cd /mydir/tools/daemon
# make
# cp ./ispcp_daemon /var/www/ispcp/daemon/ispcp_daemon


-------------------
Finish update
-------------------

1) Now you should execute the ISPCP engine manually, because users/customers may have made system changes during your update operation
   This could take a moment!

# /var/www/ispcp/engine/ispcp-rqst-mngr

2) Now you can start the daemons

# /etc/init.d/apache2 restart
# /etc/init.d/proftpd restart
# /etc/init.d/ispcp_daemon start


ISPCP is successfully updated !
